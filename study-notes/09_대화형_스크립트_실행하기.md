# ëŒ€í™”í˜• ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰í•˜ê¸°

## ë³€ê²½ ê°œìš”

ë¸Œë¼ìš°ì €ì— JavaScript ì‹¤í–‰ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ì—¬ ì›¹í˜ì´ì§€ê°€ ë™ì ìœ¼ë¡œ ë™ì‘í•  ìˆ˜ ìˆë„ë¡ ê°œì„ 
ì´ì œ ë¸Œë¼ìš°ì €ê°€ JavaScript ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³ , ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë©°, DOMì„ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì£¼ìš” ë³€ê²½ ì‚¬í•­

### 1. JavaScript ì‹¤í–‰ í™˜ê²½ ì¶”ê°€

```diff
 import tkinter
 import tkinter.font
 import urllib.parse
+import dukpy
```

**ì„¤ëª…**

- `dukpy`: Pythonì—ì„œ JavaScript ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

---

### 2. JSContext í´ë˜ìŠ¤ ì¶”ê°€

```diff
+EVENT_DISPATCH_JS = \
+    "new Node(dukpy.handle).dispatchEvent(new Event(dukpy.type))"
+
+RUNTIME_JS = open("runtime.js").read()
+
+class JSContext:
+    def __init__(self, tab):
+        self.tab = tab
+
+        self.interp = dukpy.JSInterpreter()
+        self.interp.export_function("log", print)
+        self.interp.export_function("querySelectorAll",
+            self.querySelectorAll)
+        self.interp.export_function("getAttribute",
+            self.getAttribute)
+        self.interp.export_function("innerHTML_set", self.innerHTML_set)
+        self.interp.evaljs(RUNTIME_JS)
+
+        self.node_to_handle = {}
+        self.handle_to_node = {}
```

**ì½”ë“œ ì„¤ëª…**

| êµ¬ì„±ìš”ì†Œ            | ì—­í•                                                  |
| ------------------- | ---------------------------------------------------- |
| `EVENT_DISPATCH_JS` | ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¤ëŠ” JavaScript ì½”ë“œ í…œí”Œë¦¿           |
| `RUNTIME_JS`        | ë¸Œë¼ìš°ì € JavaScript APIë¥¼ ì œê³µí•˜ëŠ” ëŸ°íƒ€ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ |
| `JSContext`         | JavaScript ì‹¤í–‰ í™˜ê²½ì„ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤               |
| `self.interp`       | dukpy JavaScript ì¸í„°í”„ë¦¬í„° ì¸ìŠ¤í„´ìŠ¤                 |
| `export_function()` | Python í•¨ìˆ˜ë¥¼ JavaScriptì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ ë…¸ì¶œ      |
| `node_to_handle`    | Python DOM ë…¸ë“œ â†’ JavaScript í•¸ë“¤ ID ë§¤í•‘            |
| `handle_to_node`    | JavaScript í•¸ë“¤ ID â†’ Python DOM ë…¸ë“œ ë§¤í•‘            |

**Python â†” JavaScript ë¸Œë¦¬ì§€**

- JavaScriptì—ì„œ `log()`, `querySelectorAll()`, `getAttribute()`, `innerHTML_set()` í˜¸ì¶œ ê°€ëŠ¥
- Python í•¨ìˆ˜ê°€ ì‹¤ì œ êµ¬í˜„ì„ ë‹´ë‹¹í•˜ê³  ê²°ê³¼ë¥¼ JavaScriptë¡œ ë°˜í™˜

---

### 3. Python-JavaScript ë¸Œë¦¬ì§€

#### `export_function`ê³¼ `call_python`ì˜ ì—°ê²°

```python
# Pythonì—ì„œ í•¨ìˆ˜ ë“±ë¡
self.interp.export_function("log", print)
#                           â†‘      â†‘
#                         ì´ë¦„   ì‹¤ì œ Python í•¨ìˆ˜
```

```javascript
// JavaScriptì—ì„œ í˜¸ì¶œ (runtime.js)
console = {
  log: function (x) {
    call_python("log", x); // Pythonì— ë“±ë¡ëœ ì´ë¦„ ì‚¬ìš©
  },
};
```

#### ì‹¤í–‰ íë¦„

```
ì›¹í˜ì´ì§€ JavaScript
   console.log("Hello")
         â†“
runtime.js
   call_python("log", "Hello")
         â†“
dukpy ë¸Œë¦¬ì§€
   "log" ì´ë¦„ìœ¼ë¡œ ë“±ë¡ëœ í•¨ìˆ˜ ì°¾ê¸°
         â†“
Python
   print("Hello")  # ì‹¤ì œ ì‹¤í–‰
         â†“
í„°ë¯¸ë„ ì¶œë ¥
   Hello
```

#### í•µì‹¬ ê°œë…

**`call_python`ì€ ì–´ë””ì„œ ì™”ë‚˜?**

- `dukpy.JSInterpreter()` ìƒì„± ì‹œ **ìë™ìœ¼ë¡œ JavaScript ì „ì—­ ìŠ¤ì½”í”„ì— ì£¼ì…**
- ë³„ë„ì˜ importë‚˜ ì •ì˜ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
- dukpy ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì œê³µí•˜ëŠ” ë§ˆë²•ì˜ í•¨ìˆ˜

---

### 4. JavaScript ì½”ë“œ ì‹¤í–‰ ë° ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜

```diff
+    def run(self, script, code):
+        try:
+            return self.interp.evaljs(code)
+        except dukpy.JSRuntimeError as e:
+            print("Script", script, "crashed", e)
+
+    def dispatch_event(self, type, elt):
+        handle = self.node_to_handle.get(elt, -1)
+        do_default = self.interp.evaljs(
+            EVENT_DISPATCH_JS, type=type, handle=handle)
+        return not do_default
```

**ë©”ì„œë“œ ì„¤ëª…**

| ë©”ì„œë“œ             | ê¸°ëŠ¥                                            | ë°˜í™˜ê°’                                    |
| ------------------ | ----------------------------------------------- | ----------------------------------------- |
| `run()`            | JavaScript ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  ì˜¤ë¥˜ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ | ì‹¤í–‰ ê²°ê³¼ ë˜ëŠ” None                       |
| `dispatch_event()` | DOM ìš”ì†Œì— ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¤ê³  í•¸ë“¤ëŸ¬ ì‹¤í–‰      | `preventDefault()` í˜¸ì¶œ ì—¬ë¶€ (True/False) |

**ë™ì‘ íë¦„**

1. ì‚¬ìš©ì ì•¡ì…˜ ë°œìƒ (í´ë¦­, í‚¤ ì…ë ¥ ë“±)
2. `dispatch_event()` í˜¸ì¶œ
3. JavaScript ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰
4. `preventDefault()` í˜¸ì¶œ ì—¬ë¶€ì— ë”°ë¼ ê¸°ë³¸ ë™ì‘ ì‹¤í–‰/ì·¨ì†Œ

#### JavaScript ëŸ°íƒ€ì„ ì—ëŸ¬ ì²˜ë¦¬

```python
def run(self, script, code):
    try:
        return self.interp.evaljs(code)  # JavaScript ì‹¤í–‰
    except dukpy.JSRuntimeError as e:   # ì—ëŸ¬ ë°œìƒ ì‹œ
        print("Script", script, "crashed", e)  # ë¡œê·¸ë§Œ ì¶œë ¥í•˜ê³  ê³„ì† ì§„í–‰
```

**ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ**

| í•­ëª©               | ì„¤ëª…                                                         |
| ------------------ | ------------------------------------------------------------ |
| **ì—ëŸ¬ ë°œìƒ ì‹œì ** | JavaScript ì½”ë“œ ì‹¤í–‰ ì¤‘ ë¬¸ë²• ì˜¤ë¥˜, ëŸ°íƒ€ì„ ì˜¤ë¥˜, ì˜ˆì™¸ ë°œìƒ ì‹œ |
| **ì²˜ë¦¬ ë°©ì‹**      | ì—ëŸ¬ë¥¼ ì¶œë ¥í•˜ê³  **ë¸Œë¼ìš°ì €ëŠ” ê³„ì† ë™ì‘** (ì¤‘ë‹¨í•˜ì§€ ì•ŠìŒ)     |
| **ì˜í–¥ ë²”ìœ„**      | í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤íŒ¨, ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì •ìƒ ì‹¤í–‰              |
| **ì‚¬ìš©ì ê²½í—˜**    | ì¼ë¶€ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì§€ë§Œ ë¸Œë¼ìš°ì € ìì²´ëŠ” ì•ˆì •ì    |

**ì—ëŸ¬ ë°œìƒ ì˜ˆì‹œ**

```javascript
// 1. ë¬¸ë²• ì˜¤ë¥˜
function test( {  // SyntaxError: ê´„í˜¸ ëˆ„ë½
    console.log("test");
}

// 2. ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë³€ìˆ˜
console.log(undefinedVariable);  // ReferenceError

// 3. ì˜ëª»ëœ í•¨ìˆ˜ í˜¸ì¶œ
null.someMethod();  // TypeError: nullì—ì„œ ë©”ì„œë“œ í˜¸ì¶œ ë¶ˆê°€

// 4. Python í•¨ìˆ˜ í˜¸ì¶œ ì‹¤íŒ¨
call_python("nonExistent", x);  // Pythonì— ë“±ë¡ë˜ì§€ ì•Šì€ í•¨ìˆ˜
```

**ì‹¤ì œ ë™ì‘**

```
í˜ì´ì§€ ë¡œë“œ
   â†“
script1.js ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰ â†’ âœ… ì„±ê³µ
   â†“
script2.js ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰ â†’ âŒ ì—ëŸ¬ ë°œìƒ
   â†“                            â†“
   |                    ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
   |                    "Script script2.js crashed ..."
   |                            â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ê³„ì† ì§„í–‰ (ë¸Œë¼ìš°ì € ë©ˆì¶”ì§€ ì•ŠìŒ)
   â†“
script3.js ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰ â†’ âœ… ì„±ê³µ
   â†“
í˜ì´ì§€ ë Œë”ë§ ì™„ë£Œ
```

---

### 5. DOM API êµ¬í˜„

##### í•¸ë“¤ ìƒì„± ê³¼ì • (ë‹¨ê³„ë³„ ì„¤ëª…)

**ì˜ˆì‹œ HTML:**

```html
<html>
  <body>
    <div id="first">ì²« ë²ˆì§¸</div>
    <p>ë‹¨ë½</p>
    <div id="second">ë‘ ë²ˆì§¸</div>
  </body>
</html>
```

**Step 1: í˜ì´ì§€ ë¡œë“œ ì‹œ (ì´ˆê¸° ìƒíƒœ)**

```python
# Python
node_to_handle = {}  # ë¹„ì–´ìˆìŒ
handle_to_node = {}  # ë¹„ì–´ìˆìŒ
```

**Step 2: JavaScriptì—ì„œ ì²« ìš”ì²­**

```javascript
// JavaScript
document.querySelectorAll("div");
```

**Step 3: Pythonì—ì„œ DOM ë…¸ë“œ ì°¾ê¸°**

```python
# Pythonì˜ querySelectorAll ë©”ì„œë“œ
nodes = [<Element div id="first">, <Element div id="second">]
# 2ê°œì˜ div ìš”ì†Œë¥¼ ì°¾ìŒ
```

**Step 4: ê° ë…¸ë“œì— í•¸ë“¤ ID ë¶€ì—¬ (get_handle í˜¸ì¶œ)**

```python
# ì²« ë²ˆì§¸ div ì²˜ë¦¬
def get_handle(elt):  # elt = <Element div id="first">
    if elt not in self.node_to_handle:  # ì²˜ìŒ ë³´ëŠ” ë…¸ë“œ
        handle = len(self.node_to_handle)  # í˜„ì¬ ë”•ì…”ë„ˆë¦¬ í¬ê¸° = 0
        self.node_to_handle[elt] = handle  # ë…¸ë“œ â†’ 0
        self.handle_to_node[handle] = elt  # 0 â†’ ë…¸ë“œ
    return handle  # 0 ë°˜í™˜

# ê²°ê³¼:
# node_to_handle = {<div#first>: 0}
# handle_to_node = {0: <div#first>}
```

```python
# ë‘ ë²ˆì§¸ div ì²˜ë¦¬
def get_handle(elt):  # elt = <Element div id="second">
    if elt not in self.node_to_handle:  # ì²˜ìŒ ë³´ëŠ” ë…¸ë“œ
        handle = len(self.node_to_handle)  # í˜„ì¬ ë”•ì…”ë„ˆë¦¬ í¬ê¸° = 1
        self.node_to_handle[elt] = handle  # ë…¸ë“œ â†’ 1
        self.handle_to_node[handle] = elt  # 1 â†’ ë…¸ë“œ
    return handle  # 1 ë°˜í™˜

# ê²°ê³¼:
# node_to_handle = {<div#first>: 0, <div#second>: 1}
# handle_to_node = {0: <div#first>, 1: <div#second>}
```

**Step 5: í•¸ë“¤ ID ë¦¬ìŠ¤íŠ¸ ë°˜í™˜**

```python
# Python
return [self.get_handle(node) for node in nodes]
# ë°˜í™˜ê°’: [0, 1]  â† ì •ìˆ˜ ë¦¬ìŠ¤íŠ¸!
```

**Step 6: JavaScriptì—ì„œ Node ê°ì²´ ìƒì„±**

```javascript
// JavaScriptì˜ runtime.js
document.querySelectorAll = function (s) {
  var handles = call_python("querySelectorAll", s); // [0, 1] ë°›ìŒ
  return handles.map(function (h) {
    return new Node(h);
  });
};

// ê²°ê³¼: [Node{handle:0}, Node{handle:1}]
```

##### í•¸ë“¤ ID ì‚¬ìš© ì˜ˆì‹œ

**JavaScriptì—ì„œ ì†ì„± ê°€ì ¸ì˜¤ê¸°:**

```javascript
// JavaScript
var divs = document.querySelectorAll("div");
// divs = [Node{handle:0}, Node{handle:1}]

var href = divs[0].getAttribute("id");
//              â†“
// Node.prototype.getAttribute í˜¸ì¶œ
Node.prototype.getAttribute = function (attr) {
  return call_python("getAttribute", this.handle, attr);
  //                                  â†‘
  //                            0ì„ Pythonìœ¼ë¡œ ì „ì†¡
};
```

**Pythonì—ì„œ ì‹¤ì œ DOM ì ‘ê·¼:**

```python
# Pythonì˜ getAttribute ë©”ì„œë“œ
def getAttribute(self, handle, attr):  # handle=0, attr="id"
    elt = self.handle_to_node[handle]  # 0ë²ˆ â†’ <div#first> ì°¾ê¸°
    attr = elt.attributes.get(attr, None)  # {"id": "first"} â†’ "first"
    return attr if attr else ""  # "first" ë°˜í™˜
```

##### í•µì‹¬ ê°œë… ì •ë¦¬

| ê°œë…               | ì„¤ëª…                               | ì˜ˆì‹œ             |
| ------------------ | ---------------------------------- | ---------------- |
| **í•¸ë“¤ ID**        | DOM ë…¸ë“œë¥¼ ê°€ë¦¬í‚¤ëŠ” ì •ìˆ˜ ë²ˆí˜¸      | `0`, `1`, `2`    |
| **node_to_handle** | Python ë…¸ë“œ â†’ í•¸ë“¤ ID ì°¾ê¸°         | `{<div>: 0}`     |
| **handle_to_node** | í•¸ë“¤ ID â†’ Python ë…¸ë“œ ì°¾ê¸°         | `{0: <div>}`     |
| **Node ê°ì²´**      | JavaScriptì—ì„œ í•¸ë“¤ IDë¥¼ ê°ì‹¼ ë˜í¼ | `Node{handle:0}` |

##### ì¤‘ìš”í•œ í¬ì¸íŠ¸! ğŸ¯

**JavaScriptëŠ” í•¸ë“¤ IDë§Œ ì•Œê³ , ì‹¤ì œ ë°ì´í„°ëŠ” Pythonì— ìˆë‹¤!**

```
JavaScript ì¸¡                     Python ì¸¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Node {                           Element {
  handle: 0                        tag: "div",
}                                  attributes: {"id": "first", "class": "box"},
                                   children: [...],
â†‘ ë²ˆí˜¸ë§Œ ì•Œê³  ìˆìŒ!                  text: "Hello"
                                 }
                                 â†‘ ëª¨ë“  ì‹¤ì œ ë°ì´í„° ë³´ê´€
```

**ëª¨ë“  ë°ì´í„° ì ‘ê·¼ì€ Pythonì„ í†µí•œë‹¤**

```javascript
// JavaScript
var element = document.querySelectorAll("div")[0];
// element = Node { handle: 0 }  â† í•¸ë“¤ IDë§Œ ìˆìŒ!

// ì†ì„±ì„ ê°€ì ¸ì˜¤ë ¤ë©´?
element.getAttribute("id");
// â†’ call_python("getAttribute", 0, "id")
// â†’ Pythonì´ handle_to_node[0]ìœ¼ë¡œ ì‹¤ì œ Element ì°¾ê¸°
// â†’ Element.attributes["id"] ë°˜í™˜
// â†’ "first"ë¥¼ JavaScriptë¡œ ì „ë‹¬
```

**ì™œ ì´ë ‡ê²Œ í•˜ë‚˜?**

1. **ë¶„ë¦¬ëœ ë©”ëª¨ë¦¬ ê³µê°„**: Python ë©”ëª¨ë¦¬ â‰  JavaScript ë©”ëª¨ë¦¬
2. **ë°ì´í„° ë™ê¸°í™”**: Pythonì˜ DOMì´ "ì§„ì‹¤ì˜ ì›ì²œ"
3. **íš¨ìœ¨ì„±**: ê°ì²´ ì „ì²´ë¥¼ ë³µì‚¬í•˜ì§€ ì•Šê³  í•„ìš”í•œ ê²ƒë§Œ ìš”ì²­

**ë¹„ìœ :**

```
JavaScript = ë¦¬ëª¨ì»¨ (ë²„íŠ¼ ë²ˆí˜¸ë§Œ ì•Œê³  ìˆìŒ)
Python = TV (ì‹¤ì œ ì±„ë„ ë°ì´í„° ë³´ê´€)

ë¦¬ëª¨ì»¨ì—ì„œ "0ë²ˆ ì±„ë„ ì´ë¦„ ë­ì•¼?" ë²„íŠ¼ ëˆ„ë¥´ë©´
â†’ TVê°€ 0ë²ˆ ì±„ë„ ì •ë³´ í™•ì¸í•´ì„œ ì•Œë ¤ì¤Œ
```

#### DOM ì¡°ì‘ API

```diff
+    def querySelectorAll(self, selector_text):
+        selector = CSSParser(selector_text).selector()
+        nodes = [node for node
+                 in tree_to_list(self.tab.nodes, [])
+                 if selector.matches(node)]
+        return [self.get_handle(node) for node in nodes]
+
+    def getAttribute(self, handle, attr):
+        elt = self.handle_to_node[handle]
+        attr = elt.attributes.get(attr, None)
+        return attr if attr else ""
+
+    def innerHTML_set(self, handle, s):
+        doc = HTMLParser("<html><body>" + s + "</body></html>").parse()
+        new_nodes = doc.children[0].children
+        elt = self.handle_to_node[handle]
+        elt.children = new_nodes
+        for child in elt.children:
+            child.parent = elt
+        self.tab.render()
```

**DOM ì¡°ì‘ API**

| API                  | JavaScript ì‚¬ìš© ì˜ˆì‹œ               | ë™ì‘                                               |
| -------------------- | ---------------------------------- | -------------------------------------------------- |
| `querySelectorAll()` | `document.querySelectorAll("div")` | CSS ì…€ë ‰í„°ë¡œ ìš”ì†Œë“¤ì„ ê²€ìƒ‰í•˜ì—¬ í•¸ë“¤ ID ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ |
| `getAttribute()`     | `element.getAttribute("href")`     | ìš”ì†Œì˜ ì†ì„±ê°’ì„ ê°€ì ¸ì˜´ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)          |
| `innerHTML_set()`    | `element.innerHTML = "<p>Hi</p>"`  | ìš”ì†Œì˜ ë‚´ë¶€ HTMLì„ ë³€ê²½í•˜ê³  ìë™ ë Œë”ë§            |

**API ì‹¤í–‰ ê³¼ì •**

```javascript
// JavaScript
var divs = document.querySelectorAll("div");  // 1. JavaScript í˜¸ì¶œ
    â†“
// Python
[self.get_handle(node) for node in nodes]     // 2. í•¸ë“¤ ID ë¦¬ìŠ¤íŠ¸ ìƒì„±
    â†“ [0, 5, 8]
// JavaScript
[0, 5, 8].map(h => new Node(h))               // 3. Node ê°ì²´ ë°°ì—´ ìƒì„±
    â†“
// ì‚¬ìš©
divs[0].getAttribute("class")                 // 4. í•¸ë“¤ë¡œ Python í•¨ìˆ˜ í˜¸ì¶œ
    â†“
// Python
self.handle_to_node[0].attributes.get("class") // 5. ì‹¤ì œ DOM ë…¸ë“œì—ì„œ ì†ì„± ê°€ì ¸ì˜¤ê¸°
```

**í•µì‹¬ ë™ì‘**

- JavaScriptì˜ DOM ì¡°ì‘ ìš”ì²­ â†’ í•¸ë“¤ IDë¡œ ë³€í™˜ â†’ Pythonì´ ì‹¤ì œ DOM íŠ¸ë¦¬ ìˆ˜ì • â†’ í™”ë©´ ìë™ ì—…ë°ì´íŠ¸

---

### 6. í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

```diff
     def load(self, url, payload=None):
         self.url = url
         self.history.append(url)
         body = url.request(payload)
         self.nodes = HTMLParser(body).parse()

+        self.js = JSContext(self)
+        scripts = [node.attributes["src"] for node
+                   in tree_to_list(self.nodes, [])
+                   if isinstance(node, Element)
+                   and node.tag == "script"
+                   and "src" in node.attributes]
+        for script in scripts:
+            script_url = url.resolve(script)
+            try:
+                body = script_url.request()
+            except:
+                continue
+            self.js.run(script, body)
```

**ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ê³¼ì •**

```
í˜ì´ì§€ ë¡œë“œ
   â†“
HTML íŒŒì‹±
   â†“
<script src="..."> íƒœê·¸ ê²€ìƒ‰
   â†“
JavaScript íŒŒì¼ ë‹¤ìš´ë¡œë“œ
   â†“
ìˆœì°¨ì ìœ¼ë¡œ ì½”ë“œ ì‹¤í–‰
   â†“
ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ ì™„ë£Œ
```

**ì£¼ìš” íŠ¹ì§•**

- ì™¸ë¶€ JavaScript íŒŒì¼ë§Œ ì§€ì› (ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¯¸ì§€ì›)
- ìŠ¤í¬ë¦½íŠ¸ëŠ” HTMLì— ë‚˜íƒ€ë‚œ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰
- ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê±´ë„ˆë›°ê³  ê³„ì† ì§„í–‰

---

### 7. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í†µí•©

#### ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ êµ¬ì¡°

**í•µì‹¬ ì•„ì´ë””ì–´:** Pythonì€ DOM ê°ì²´ì— ì§ì ‘ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë‹¬ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, **í•¸ë“¤ IDë¥¼ í‚¤ë¡œ ì‚¬ìš©í•˜ëŠ” LISTENERS ê°ì²´**ì— ì €ì¥í•©ë‹ˆë‹¤.

##### JavaScript ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ (runtime.js)

```javascript
// ì „ì—­ ë¦¬ìŠ¤ë„ˆ ì €ì¥ì†Œ: í•¸ë“¤ IDë¥¼ í‚¤ë¡œ ì‚¬ìš©
LISTENERS = {};
// êµ¬ì¡°: { í•¸ë“¤ID: { ì´ë²¤íŠ¸íƒ€ì…: [í•¨ìˆ˜1, í•¨ìˆ˜2, ...] } }

// Event ìƒì„±ì
function Event(type) {
  this.type = type;
  this.do_default = true; // ê¸°ë³¸ ë™ì‘ ì‹¤í–‰ ì—¬ë¶€
}

Event.prototype.preventDefault = function () {
  this.do_default = false; // ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
};

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
Node.prototype.addEventListener = function (type, listener) {
  if (!LISTENERS[this.handle]) LISTENERS[this.handle] = {};
  var dict = LISTENERS[this.handle];
  if (!dict[type]) dict[type] = [];
  var list = dict[type];
  list.push(listener); // ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
};

// ì´ë²¤íŠ¸ ë°œìƒ ë° ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰
Node.prototype.dispatchEvent = function (evt) {
  var type = evt.type;
  var handle = this.handle;
  var list = (LISTENERS[handle] && LISTENERS[handle][type]) || [];
  for (var i = 0; i < list.length; i++) {
    list[i].call(this, evt); // ê° ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰
  }
  return evt.do_default; // preventDefault í˜¸ì¶œ ì—¬ë¶€ ë°˜í™˜
};
```

##### LISTENERS ì €ì¥ì†Œ êµ¬ì¡°

```javascript
// ì˜ˆì‹œ: 2ê°œì˜ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
LISTENERS = {
  0: {
    // í•¸ë“¤ ID 0ë²ˆ (ì²« ë²ˆì§¸ div)
    click: [function1, function2], // í´ë¦­ ë¦¬ìŠ¤ë„ˆ 2ê°œ
    keydown: [function3], // í‚¤ë‹¤ìš´ ë¦¬ìŠ¤ë„ˆ 1ê°œ
  },
  1: {
    // í•¸ë“¤ ID 1ë²ˆ (ë‘ ë²ˆì§¸ div)
    click: [function4], // í´ë¦­ ë¦¬ìŠ¤ë„ˆ 1ê°œ
  },
};
```

##### ì´ë²¤íŠ¸ ë“±ë¡ ê³¼ì • (ë‹¨ê³„ë³„ ì˜ˆì‹œ)

```javascript
// Step 1: JavaScriptì—ì„œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
var button = document.querySelectorAll("button")[0];
// button = Node { handle: 5 }

// Step 2: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
button.addEventListener("click", function (e) {
  console.log("ë²„íŠ¼ í´ë¦­ë¨!");
  e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨
});

// Step 3: LISTENERSì— ì €ì¥ë¨
LISTENERS = {
  5: {
    // í•¸ë“¤ ID 5ë²ˆ
    click: [
      function (e) {
        console.log("ë²„íŠ¼ í´ë¦­ë¨!");
        e.preventDefault();
      },
    ],
  },
};
```

##### Pythonì—ì„œ ì´ë²¤íŠ¸ ë°œìƒ (browser.py)

```diff
             elif elt.tag == "a" and "href" in elt.attributes:
+                if self.js.dispatch_event("click", elt): return
                 url = self.url.resolve(elt.attributes["href"])
                 return self.load(url)
             elif elt.tag == "input":
+                if self.js.dispatch_event("click", elt): return
                 elt.attributes["value"] = ""
             elif elt.tag == "button":
+                if self.js.dispatch_event("click", elt): return
                 while elt:
                     if elt.tag == "form" and "action" in elt.attributes:
                         return self.submit_form(elt)

     def submit_form(self, elt):
+        if self.js.dispatch_event("submit", elt): return
         inputs = [node for node in tree_to_list(elt, [])

     def keypress(self, char):
         if self.focus:
+            if self.js.dispatch_event("keydown", self.focus): return
             self.focus.attributes["value"] += char
```

##### preventDefault ë™ì‘ ì›ë¦¬

**ì „ì²´ íë¦„ ì˜ˆì œ**: ì‚¬ìš©ìê°€ `<a href="http://example.org">` ë§í¬ë¥¼ í´ë¦­í–ˆì„ ë•Œ

**1ë‹¨ê³„: ì´ë²¤íŠ¸ ê°ì²´ ìƒì„± (JavaScript)**

```javascript
// runtime.jsì˜ Event ìƒì„±ì
function Event(type) {
  this.type = type; // "click"
  this.do_default = true; // ì´ˆê¸°ê°’: ê¸°ë³¸ ë™ì‘ í—ˆìš© (ë§í¬ ì´ë™ ì‹¤í–‰)
}

// ì‹¤ì œ ìƒì„±ëœ ê°ì²´ ìƒíƒœ
// {
//   type: "click",
//   do_default: true  â† ì´ ê°’ì´ í•µì‹¬!
// }
```

**2ë‹¨ê³„: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ (JavaScript)**

```javascript
// ì›¹ í˜ì´ì§€ì˜ JavaScript ì½”ë“œ
var link = document.querySelectorAll("a")[0]; // í•¸ë“¤: 5

link.addEventListener("click", function (e) {
  console.log("ë§í¬ í´ë¦­ë¨!");

  // ì—¬ê¸°ì„œ ê¸°ë³¸ ë™ì‘(ë§í¬ ì´ë™)ì„ ë§‰ê³  ì‹¶ë‹¤ë©´?
  e.preventDefault(); // â† ì´ í•¨ìˆ˜ í˜¸ì¶œ!
});

// preventDefault í•¨ìˆ˜ ë‚´ë¶€ (runtime.js)
Event.prototype.preventDefault = function () {
  this.do_default = false; // true â†’ falseë¡œ ë³€ê²½!
};

// ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ í›„ ì´ë²¤íŠ¸ ê°ì²´ ìƒíƒœ
// {
//   type: "click",
//   do_default: false  â† ë³€ê²½ë¨! (ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨ ìš”ì²­)
// }
```

**3ë‹¨ê³„: dispatchEvent ë°˜í™˜ê°’ í™•ì¸ (JavaScript)**

```javascript
// runtime.jsì˜ dispatchEvent í•¨ìˆ˜
Node.prototype.dispatchEvent = function (evt) {
  var type = evt.type; // "click"
  var handle = this.handle; // 5
  var list = LISTENERS[handle][type] || []; // ë“±ë¡ëœ ë¦¬ìŠ¤ë„ˆ ë°°ì—´

  // ëª¨ë“  ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰
  for (var i = 0; i < list.length; i++) {
    list[i].call(this, evt); // ì—¬ê¸°ì„œ preventDefault() í˜¸ì¶œë¨
  }

  // ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ í›„ do_default ê°’ ë°˜í™˜
  return evt.do_default; // false ë°˜í™˜ â† Pythonì—ê²Œ "ê¸°ë³¸ ë™ì‘ í•˜ì§€ ë§ˆì„¸ìš”" ì‹ í˜¸
};
```

**4ë‹¨ê³„: Pythonì´ ë°˜í™˜ê°’ ë°›ê¸°**

```python
# browser.pyì˜ dispatch_event í•¨ìˆ˜
def dispatch_event(self, type, elt):
    handle = self.node_to_handle.get(elt, -1)

    # JavaScript ì‹¤í–‰: "new Node(handle).dispatchEvent(new Event(type))"
    code = "new Node({}).dispatchEvent(new Event('{}'))".format(handle, type)

    do_default = self.interp.evaljs(code)
    # do_default = false (JavaScriptê°€ ë°˜í™˜í•œ ê°’)

    return not do_default
    # not False = True â† "ê¸°ë³¸ ë™ì‘ì„ ì¤‘ë‹¨í•˜ë¼"ëŠ” ì˜ë¯¸
```

**5ë‹¨ê³„: Pythonì´ ê¸°ë³¸ ë™ì‘ ì‹¤í–‰ ì—¬ë¶€ ê²°ì •**

```python
# browser.pyì˜ handle_click í•¨ìˆ˜ (ë§í¬ í´ë¦­ ì²˜ë¦¬)
def handle_click(self, e):
    # ... x, y ì¢Œí‘œë¡œ í´ë¦­ëœ ìš”ì†Œ ì°¾ê¸° ...

    if elt.tag == "a" and "href" in elt.attributes:
        # JavaScript ì´ë²¤íŠ¸ ë””ìŠ¤íŒ¨ì¹˜
        if self.js.dispatch_event("click", elt):
            # Trueê°€ ë°˜í™˜ë¨ = JavaScriptê°€ preventDefault() í˜¸ì¶œí•¨
            # â†’ ê¸°ë³¸ ë™ì‘(ë§í¬ ì´ë™) ì¤‘ë‹¨!
            return  # â† ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ! ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ì•ˆ í•¨

        # preventDefault()ê°€ í˜¸ì¶œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì—¬ê¸° ë„ë‹¬
        url = self.url.resolve(elt.attributes["href"])
        self.load(url)  # â† ë§í¬ ì´ë™ ì‹¤í–‰
```

**ì™„ì „í•œ ì˜ˆì œ: ë³€ìˆ˜ ìƒíƒœ ì¶”ì **

| ë‹¨ê³„ | ìœ„ì¹˜       | ì½”ë“œ                                   | `evt.do_default` | `do_default` (Python) | ê²°ê³¼                      |
| ---- | ---------- | -------------------------------------- | ---------------- | --------------------- | ------------------------- |
| 1    | JavaScript | `new Event("click")`                   | `true`           | (ì•„ì§ ì—†ìŒ)           | ì´ë²¤íŠ¸ ìƒì„±               |
| 2    | JavaScript | `evt.preventDefault()`                 | `false` âœ…       | (ì•„ì§ ì—†ìŒ)           | ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨ ìš”ì²­       |
| 3    | JavaScript | `return evt.do_default`                | `false`          | (ì•„ì§ ì—†ìŒ)           | Pythonì—ê²Œ `false` ì „ë‹¬   |
| 4    | Python     | `do_default = self.interp.evaljs(...)` | (JavaScript ë)  | `False`               | Pythonì´ ê°’ ë°›ìŒ          |
| 5    | Python     | `return not do_default`                | (JavaScript ë)  | `not False = True`    | "ì¤‘ë‹¨í•˜ë¼" ì‹ í˜¸ ë°˜í™˜      |
| 6    | Python     | `if self.js.dispatch_event(...)`       | (JavaScript ë)  | `True`                | ì¡°ê±´ë¬¸ ì°¸ â†’ `return` ì‹¤í–‰ |
| 7    | Python     | `return` (ë§í¬ ì´ë™ ì½”ë“œì— ë„ë‹¬ ì•ˆ í•¨) | (JavaScript ë)  | (ì‚¬ìš© ë)             | **ë§í¬ ì´ë™ ì•ˆ í•¨** âœ…    |

**ë°˜ëŒ€ ì¼€ì´ìŠ¤: preventDefault() í˜¸ì¶œ ì•ˆ í–ˆì„ ë•Œ**

```javascript
// ë¦¬ìŠ¤ë„ˆì—ì„œ preventDefault() í˜¸ì¶œ ì•ˆ í•¨
link.addEventListener("click", function (e) {
  console.log("ë§í¬ í´ë¦­ë¨!");
  // e.preventDefault(); â† ì´ ì¤„ì´ ì—†ìŒ!
});

// ì´ë²¤íŠ¸ ê°ì²´ ìƒíƒœ
// {
//   type: "click",
//   do_default: true  â† ê·¸ëŒ€ë¡œ ìœ ì§€ë¨
// }
```

| ë‹¨ê³„ | ìœ„ì¹˜       | ì½”ë“œ                                   | `evt.do_default` | `do_default` (Python) | ê²°ê³¼                   |
| ---- | ---------- | -------------------------------------- | ---------------- | --------------------- | ---------------------- |
| 1    | JavaScript | `new Event("click")`                   | `true`           | (ì•„ì§ ì—†ìŒ)           | ì´ë²¤íŠ¸ ìƒì„±            |
| 2    | JavaScript | (preventDefault í˜¸ì¶œ ì•ˆ í•¨)            | `true` âœ…        | (ì•„ì§ ì—†ìŒ)           | do_default ê·¸ëŒ€ë¡œ      |
| 3    | JavaScript | `return evt.do_default`                | `true`           | (ì•„ì§ ì—†ìŒ)           | Pythonì—ê²Œ `true` ì „ë‹¬ |
| 4    | Python     | `do_default = self.interp.evaljs(...)` | (JavaScript ë)  | `True`                | Pythonì´ ê°’ ë°›ìŒ       |
| 5    | Python     | `return not do_default`                | (JavaScript ë)  | `not True = False`    | "ê³„ì†í•˜ë¼" ì‹ í˜¸ ë°˜í™˜   |
| 6    | Python     | `if self.js.dispatch_event(...)`       | (JavaScript ë)  | `False`               | ì¡°ê±´ë¬¸ ê±°ì§“ â†’ í†µê³¼     |
| 7    | Python     | `self.load(url)`                       | (JavaScript ë)  | (ì‚¬ìš© ë)             | **ë§í¬ ì´ë™ ì‹¤í–‰** âœ…  |

**í•µì‹¬ ë¡œì§: `not do_default`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ **

```python
# Python ê´€ì 
do_default = self.interp.evaljs(...)  # JavaScriptì—ì„œ ë°›ì€ ê°’

# JavaScriptì—ì„œ falseë¥¼ ë³´ëƒ„ = "ê¸°ë³¸ ë™ì‘ í•˜ì§€ ë§ˆì„¸ìš”"
# Pythonì—ì„œëŠ” Trueë¡œ ë°”ê¿”ì„œ = "ì²˜ë¦¬ ì¤‘ë‹¨í•´ì•¼ í•¨"ìœ¼ë¡œ í•´ì„

return not do_default
# JavaScript false â†’ Python True  = "ì¤‘ë‹¨í•˜ë¼"
# JavaScript true  â†’ Python False = "ê³„ì†í•˜ë¼"
```

**ì´ë²¤íŠ¸ ì²˜ë¦¬ ìˆœì„œ**

```
ì‚¬ìš©ì ì•¡ì…˜ (í´ë¦­, í‚¤ ì…ë ¥ ë“±)
   â†“
Python: dispatch_event() í˜¸ì¶œ
   â†“
JavaScript: dispatchEvent() ì‹¤í–‰
   â†“
ë“±ë¡ëœ ë¦¬ìŠ¤ë„ˆë“¤ ìˆœì°¨ ì‹¤í–‰
   â†“
preventDefault í˜¸ì¶œë¨? â”€â”€Yesâ”€â”€â†’ Pythonì— True ë°˜í™˜ â†’ ì¤‘ë‹¨
   â†“ No
Pythonì— False ë°˜í™˜ â†’ ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ì‹¤í–‰
```

##### í•µì‹¬ í¬ì¸íŠ¸

**ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ ìš”ì•½**

| ë‹¨ê³„    | ìœ„ì¹˜       | ë™ì‘                                       |
| ------- | ---------- | ------------------------------------------ |
| 1. ë“±ë¡ | JavaScript | `addEventListener()` â†’ LISTENERSì— ì €ì¥    |
| 2. ë°œìƒ | Python     | ì‚¬ìš©ì ì•¡ì…˜ ê°ì§€ â†’ `dispatch_event()` í˜¸ì¶œ |
| 3. ì „ë‹¬ | Pythonâ†’JS  | í•¸ë“¤ IDì™€ ì´ë²¤íŠ¸ íƒ€ì… ì „ë‹¬                 |
| 4. ì‹¤í–‰ | JavaScript | LISTENERSì—ì„œ ë¦¬ìŠ¤ë„ˆ ì°¾ì•„ ì‹¤í–‰             |
| 5. ë°˜í™˜ | JSâ†’Python  | `preventDefault()` í˜¸ì¶œ ì—¬ë¶€ ë°˜í™˜          |
| 6. ê²°ì • | Python     | ê¸°ë³¸ ë™ì‘ ì‹¤í–‰ ë˜ëŠ” ì¤‘ë‹¨                   |

---

## í•µì‹¬ ê°œë… ì •ë¦¬

### JavaScript ì‹¤í–‰ íë¦„

1. **í˜ì´ì§€ ë¡œë“œ**: HTML íŒŒì‹± í›„ `<script>` íƒœê·¸ë¥¼ ì°¾ì•„ JavaScript íŒŒì¼ ë‹¤ìš´ë¡œë“œ
2. **ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰**: `JSContext`ë¥¼ í†µí•´ JavaScript ì½”ë“œ ì‹¤í–‰
3. **ì´ë²¤íŠ¸ ì²˜ë¦¬**: ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì‹œ JavaScript ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í˜¸ì¶œ
4. **DOM ì¡°ì‘**: JavaScriptì—ì„œ `innerHTML`, `querySelectorAll` ë“±ìœ¼ë¡œ DOM ìˆ˜ì •
5. **í™”ë©´ ì—…ë°ì´íŠ¸**: DOM ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ë Œë”ë§

### Python-JavaScript ë¸Œë¦¬ì§€

- **Python â†’ JavaScript**: `interp.evaljs()`ë¡œ JavaScript ì½”ë“œ ì‹¤í–‰
- **JavaScript â†’ Python**: `export_function()`ìœ¼ë¡œ Python í•¨ìˆ˜ë¥¼ JavaScriptì— ë…¸ì¶œ
- **í•¸ë“¤ ì‹œìŠ¤í…œ**: DOM ë…¸ë“œì™€ JavaScript ê°ì²´ ê°„ ë§¤í•‘ìœ¼ë¡œ ì–‘ë°©í–¥ í†µì‹ 

### ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ

- **ì´ë²¤íŠ¸ íƒ€ì…**: click, submit, keydown ë“±
- **ê¸°ë³¸ ë™ì‘ ë°©ì§€**: JavaScriptì—ì„œ `preventDefault()` í˜¸ì¶œ ê°€ëŠ¥
- **ì´ë²¤íŠ¸ ë²„ë¸”ë§**: ìš”ì†Œì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•œ í›„ ë¶€ëª¨ë¡œ ì „íŒŒ

[NodeList vs HtmlCollection](bonus-notes/nodeList-vs-htmlCollection.md)
